---
title: "Data Cleaning File"
subtitle: "CT Landscape Scan - Enrollment Data"
author: "Sara McClafferty"
date: "r Sys.Date()"
output: none
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

  - Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
  - Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
  - When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
  - The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages
```{r packages, include=FALSE}
# Clear environment
rm(list = ls())

# Load packages - first pacman, installing if necessary, then others
if (!require("pacman")) install.packages("pacman"); library(pacman)
pacman::p_load(here, readxl, tidyverse, janitor, lubridate, skimr)
```

# Load Data
```{r}
# Load data
df <- read_excel(here("data/raw/enrollment/CT_district_enrollment_data.xlsx"), sheet = "Enrollment")

# Standardize column names
df <- df %>%
  clean_names %>% 
  rename(district_name = district,
         school_name = school)
```

# Validate and standardize each variable
```{r}
# year
df <- df %>% 
  mutate(school_year = factor(school_year, levels = c ("2017-18", "2018-19", "2019-20", "2020-21", "2021-22", "2022-23")))

# school_name
df <- df %>% 
  mutate(school_name = factor(district_name))

# grade
df <- df %>%
  mutate(grade = gsub(grade, pattern = "PreKindergarten", replacement = "PreK")) %>%
  mutate(grade = gsub(grade, pattern = "Kindergarten", replacement = "K")) %>% 
  mutate(grade = factor(grade, levels = c ("PreK", "K", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "All Grades")))

# gender
df <- df %>% 
  mutate(gender = factor(gender))

# race_ethnicity
df <- df %>%
  mutate(race_ethnicity = case_when(race_ethnicity == "Hispanic or Latino" ~ "Hispanic/Latino of any race",
                                    TRUE ~ race_ethnicity)) %>% 
  mutate(race_ethnicity = fct_infreq(race_ethnicity))

# english_learner_status
df <- df %>%
  mutate(english_learner_status = case_when(
    english_learner_status == "English Learners" ~ "English Learner",
    english_learner_status == "Non-English Learners" ~ "Non-English Learner",
    english_learner_status == "All Students" ~ "All Students",
    TRUE ~ NA)) %>% 
  mutate(english_learner_status = fct_infreq(english_learner_status))

# free_reduced_lunch_3_levels
df <- df %>%
  mutate(free_reduced_lunch_3_levels = case_when(free_reduced_price_lunch_eligibility == "Not Eligible for Free or Reduced-Price Meals" ~ "Not Eligible",
                                                 free_reduced_price_lunch_eligibility == "Eligible for Free Meals" ~ "Eligible for Free Meals",
                                                 free_reduced_price_lunch_eligibility == "Eligible for Reduced-Price Meals" ~ "Eligible for Reduced-Price Meals",
                                                 free_reduced_price_lunch_eligibility == "All Students" ~ "All Students",
                                                 TRUE ~ NA)) %>% 
  mutate(free_reduced_lunch_3_levels = fct_infreq(free_reduced_lunch_3_levels))

# special_education_status
df <- df %>% 
  mutate(special_education_status = fct_infreq(special_education_status))

# student_count
df <- df %>%
  mutate(student_count = as.numeric(df$student_count))
```

# Remove any empty rows or columns
```{r}
df <- df %>%
  remove_empty("rows") %>% 
  remove_empty("cols")
```

# Check for any duplicates
```{r}
 df %>%
  get_dupes()

df %>%
  get_dupes(school_year, district_name, grade)
```

# Create new variables/cols derivative of the data, to use in later analysis
```{r}
# district_name
df <- df %>% 
  mutate(district_name = factor(district_name))

# free_reduced_lunch_2_levels
df <- df %>% 
  mutate(free_reduced_lunch_2_levels = case_when(free_reduced_lunch_3_levels == "Eligible for Free Meals" ~ "Eligible",
                       free_reduced_lunch_3_levels == "Eligible for Reduced-Price Meals" ~ "Eligible",
                       free_reduced_lunch_3_levels == "Not Eligible" ~ "Not Eligible",
                       free_reduced_lunch_3_levels == "All Students" ~ "All Students",
                       TRUE ~ NA),
         free_reduced_lunch_2_levels = fct_infreq(free_reduced_lunch_2_levels))


# race_ethnicity_grouped
df <- df %>%
  mutate(race_ethnicity_grouped = case_when(race_ethnicity == "Black or African American" ~ "Black/African American", 
                                            race_ethnicity == "White" ~ "White", 
                                            race_ethnicity == "Hispanic/Latino of any race" ~ "Hispanic/Latino", 
                                            race_ethnicity == "Asian" ~ "Asian",
                                            race_ethnicity == "All Students" ~ "All Students", 
                                            TRUE ~ "All Others Combined"),
         race_ethnicity_grouped = fct_infreq(race_ethnicity_grouped))

# race_ethnicity_bipoc
df <- df %>%
  mutate(race_ethnicity_bipoc = case_when(race_ethnicity == "White" ~ "White", 
                                            race_ethnicity == "All Students" ~ "All Students", 
                                            TRUE ~ "BIPOC"),
         race_ethnicity_bipoc = fct_infreq(race_ethnicity_bipoc))
```

# Add group/subgroup info for demographics columns
```{r}
df <- df %>%
  mutate(subject = factor("All Subjects"))
```

# Drop unnecessary columns
```{r}
df <- df %>% subset(select = -c(free_reduced_price_lunch_eligibility))
```


# Write clean df to data/clean folder ---------------------
```{r}
df %>% saveRDS(here("data/clean/enrollment/enrollment.rds"))
```
